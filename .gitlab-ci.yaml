image: rust:latest

stages:
  - test
  - coverage
  - lint
  - security

variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - target/
    - .cargo/

before_script:
  - rustc --version
  - cargo --version

# Tests
test:
  stage: test
  script:
    - cargo test --verbose
  artifacts:
    reports:
      junit: report.xml
    when: always

# Cobertura de código
coverage:
  stage: coverage
  before_script:
    - cargo install cargo-tarpaulin
  script:
    - cargo tarpaulin --ignore-tests --out xml
  coverage: '/\d+\.\d+% coverage/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: cobertura.xml

# Clippy - Linting
clippy:
  stage: lint
  before_script:
    - rustup component add clippy
  script:
    - cargo clippy -- -D warnings
  allow_failure: false

# Formato de código
format:
  stage: lint
  before_script:
    - rustup component add rustfmt
  script:
    - cargo fmt -- --check
  allow_failure: false

# Auditoría de seguridad
audit:
  stage: security
  before_script:
    - cargo install cargo-audit
  script:
    - cargo audit
  allow_failure: true
  only:
    - master
    - develop
    - merge_requests
